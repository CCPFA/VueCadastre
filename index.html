<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="minimal-ui,width=device-width, initial-scale=1.0, fullscreen=true, maximum-scale=1.0, user-scalable=no", charset="UTF-8" />
    <title>Vue Cadastre</title>
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />-->
    <link rel="stylesheet" href="./src/css/L.Control.Locate.min.css" />
    <script src="https://use.fontawesome.com/9193c58103.js"></script>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css' rel='stylesheet' />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css' rel='stylesheet' />
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/css/font-awesome.min.css' />
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.0/dist/leaflet.js"></script>
    <script src="./src/js/leaflet.filelayer.js"></script>
    <script src="./src/js/togeojson.js"></script>
    <script src="./src/js/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="./src/js/l.control.geosearch.js"></script>
    <script src="./src/js/l.geosearch.provider.openstreetmap.js"></script>
    <link rel="stylesheet" href="./src/css/l.geosearch.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    <!--<script src="https://mlevans.github.io/leaflet-hash/javascripts/leaflet-hash.js"></script>-->>
    <style>
        #map {
            position: absolute;
            top:0;
            left: 0;
            right: 0;
            bottom:0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script type="text/javascript">
    	var CLE_IGN = "jcx786b3aad4khzcj6ld36a8";
    	var url_ign_scan = "https://gpp3-wxs.ign.fr/"+CLE_IGN+"/wmts?LAYER=GEOGRAPHICALGRIDSYSTEMS.MAPS&EXCEPTIONS=text/xml&FORMAT=image/jpeg&SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&STYLE=normal&TILEMATRIXSET=PM&&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}";
    	var url_ign_parcelaire ="https://gpp3-wxs.ign.fr/"+CLE_IGN+"/wmts?LAYER=CADASTRALPARCELS.PARCELS&EXCEPTIONS=text/xml&FORMAT=image/png&SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&STYLE=bdparcellaire&TILEMATRIXSET=PM&&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}";
    	var url_ign_ortho = "https://gpp3-wxs.ign.fr/"+CLE_IGN+"/wmts?LAYER=ORTHOIMAGERY.ORTHOPHOTOS&EXCEPTIONS=text/xml&FORMAT=image/jpeg&SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&STYLE=normal&TILEMATRIXSET=PM&&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}";
    	//var url_ign_lim = "https://gpp3-wxs.ign.fr/"+CLE_IGN+"/wmts?LAYER=ADMINISTRATIVEUNITS.BOUNDARIES&EXCEPTIONS=text/xml&FORMAT=image/png&SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&STYLE=normal&TILEMATRIXSET=PM&&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}"
    	
    	var ign_scan = L.tileLayer(url_ign_scan, {maxZoom: 17, detectRetina: false, attribution : '&copy; <a href="http://www.ign.fr/">IGN</a>'});
    	var ign_ortho = L.tileLayer(url_ign_ortho, {maxZoom: 19, detectRetina: false, attribution : '&copy; <a href="http://www.ign.fr/">IGN</a>'});
    	var ign_parcelaire = L.tileLayer(url_ign_parcelaire, {maxZoom: 20, detectRetina: false, zIndex: 7 ,attribution : '&copy; <a href="http://www.ign.fr/">IGN</a>'});
    	//var ign_lim = L.tileLayer(url_ign_lim, {maxZoom: 20, zIndex=8, detectRetina: false});
	var geofoncier_sommets= L.tileLayer.wms("https://api.geofoncier.fr/referentielsoge/ogc/wxs?", {layers: 'RFU_FXX_SOMMETS', format: 'image/png', maxZoom: 20, detectRetina: false, zIndex: 13, transparent: true, attribution: "© GéoFoncier"});
    	var geofoncier_limites= L.tileLayer.wms("https://api.geofoncier.fr/referentielsoge/ogc/wxs?", {layers: 'RFU_FXX_LIMITES', format: 'image/png', maxZoom: 20, detectRetina: false, zIndex: 12, transparent: true, attribution: "© GéoFoncier"});
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
	             maxZoom: 20,
	              attribution: '&copy; Openstreetmap France | &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
              });
            cadastre = L.tileLayer('http://tms.cadastre.openstreetmap.fr/*/tout/{z}/{x}/{y}.png', {
              maxZoom: 22,
              detectRetina: true,
              attribution: '<a href="http://cadastre.gouv.fr">cadastre.gouv.fr</a>',
            });
            cadastresep = L.tileLayer('http://tms.cadastre.openstreetmap.fr/**/tout/{z}/{x}/{y}.png', {
              maxZoom: 22,
              detectRetina: true,
              zIndex: 5,
              //attribution: '<a href="http://cadastre.gouv.fr">cadastre.gouv.fr</a>',
            });
            sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
             maxZoom: 18,
             detectRetina: false,
	            attribution: '&copy; Esri'
            });
	var Topo =  L.tileLayer('https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', {
		maxZoom: 20,
		attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });
        //var Topo = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        //     maxZoom: 18,
        //     detectRetina: false,
        //       attribution: '&copy; Esri'
        //    });
        var cadastre_transp = L.tileLayer('http://tms.cadastre.openstreetmap.fr/*/transp/{z}/{x}/{y}.png', {
          maxZoom: 22,
         detectRetina: true,
         attribution: '<a href="http://cadastre.gouv.fr">cadastre.gouv.fr</a>',
        });
        var cadastresep_transp = L.tileLayer('http://tms.cadastre.openstreetmap.fr/**/transp/{z}/{x}/{y}.png', {
         maxZoom: 22,
         detectRetina: true,
         zIndex: 6,
          //attribution: '<a href="http://cadastre.gouv.fr">cadastre.gouv.fr</a>',
        });
        var carthage = L.tileLayer('https://a.tile.openstreetmap.fr/route500hydro/{z}/{x}/{y}.png', {
         maxZoom: 22,
         detectRetina: false,
         zIndex: 8,
          attribution: '&copy; IGN, BD Carthage',
        });
        var map = L.map('map', {
            center: [45.19089,5.70355],
            zoom: 18,
            layers: [cadastre]
        });
        var baseMaps = {
            "Ortho IGN": ign_ortho,
            "Cartes IGN":ign_scan,
            "Topo.": Topo,
            "OpenStreetMap": osm,
            "Cadastre": cadastre
        };
        var overlays = {
          "Cadastre transparent": cadastre_transp,
          "Parcelaire IGN": ign_parcelaire,
         "GeoFoncier": geofoncier_sommets,
	  "Rivières": carthage
        };
        
        var style = {color:'red', opacity: 1.0, fillOpacity: 0.1, weight: 2, clickable: true};
        var geojsonMarkerOptions = {
          radius: 8,
          fillColor: "#ff7800",
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
          };
        var PIcon = L.AwesomeMarkers.icon({icon: 'check', markerColor: 'green', prefix: 'fa', iconColor: 'white'});
        var CIcon = L.AwesomeMarkers.icon({icon: 'gift', markerColor: 'darkblue', prefix: 'fa', iconColor: 'white'});
        var MIcon = L.AwesomeMarkers.icon({icon: 'exchange', markerColor: 'purple', prefix: 'fa', iconColor: 'white'});
        var DIcon = L.AwesomeMarkers.icon({icon: 'user', markerColor: 'blue', prefix: 'fa', iconColor: 'white'});
        var ZIcon = L.AwesomeMarkers.icon({icon: 'warning', markerColor: 'red', prefix: 'fa', iconColor: 'white'});
        var EIcon = L.AwesomeMarkers.icon({icon: 'exclamation-circle', markerColor: 'orange', prefix: 'fa', iconColor: 'white'});
        var style = {maxHeight: 200, color:'gray', opacity: 1.0, fillOpacity: 0.1, weight: 2, clickable: true};
        L.Control.FileLayerLoad.LABEL = '<i class="fa fa-folder-open"></i>';// '⌘';
        L.Control.fileLayerLoad({
            layer: L.geoJson,
            fileSizeLimit: 256000000,
            fitBounds: true,
            layerOptions: {
              pointToLayer: function(feature, latlng) {
                if (feature.properties.PCM == "P"){
                       return L.marker(latlng, {icon: PIcon}).bindPopup(feature['properties']['Description'],{maxWidth: 200, maxHeight: 350})
                   }
                else if (feature.properties.PCM == "C"){
                  return L.marker(latlng, {icon: CIcon}).bindPopup(feature['properties']['Description'],{maxWidth: 200, maxHeight: 350})
                   }
                else if (feature.properties.PCM == "M"){
                  return L.marker(latlng, {icon: CIcon}).bindPopup(feature['properties']['Description'],{maxWidth: 200, maxHeight: 350})
                  }
                else if (feature.properties.PCM == "M"){
                  return L.marker(latlng, {icon: CIcon}).bindPopup(feature['properties']['Description'],{maxWidth: 200, maxHeight: 350})
                  }
                else if (feature.properties.PCM == "2"){
                  return L.marker(latlng, {icon: DIcon}).bindPopup(feature['properties']['Description'],{maxWidth: 200, maxHeight: 350})
                  }
                else if (feature.properties.PCM == "Z"){
                  return L.marker(latlng, {icon: ZIcon}).bindPopup(feature['properties']['Description'],{maxWidth: 200, maxHeight: 350})
                  }
                 else if (feature.properties.PCM == "E"){
                   return L.marker(latlng, {icon: EIcon}).bindPopup(feature['properties']['Description'],{maxWidth: 200, maxHeight: 350})
                  }
                }
              }
            }
           ).addTo(map);
        cadastresep.setOpacity(1);
        geofoncier_limites.setOpacity(0);
        map.addLayer(cadastresep)
        //listen for cadastre
        map.on('baselayerchange', function(eo)
           {
            if( eo.name == 'Cadastre' ) {
            cadastresep.setOpacity(1);
            }
            else {
          cadastresep.setOpacity(0);
          }
          })
        cadastresep_transp.setOpacity(0);
        map.addLayer(cadastresep_transp)
         //listen for cadastre_transp
        map.on('overlayadd', function(eo)
        { 
          if( eo.name == 'Cadastre transparent' || 'Parcelaire IGN' ) {
            cadastresep_transp.setOpacity(1),
            ign_ortho.setOpacity(0.5);
            ign_scan.setOpacity(0.7);
            osm.setOpacity(0.7);
            Topo.setOpacity(0.7);
          }
         else {
            cadastresep_transp.setOpacity(0);
          }
 
        })
        map.on('overlayremove', function(eo)
        {
          if( eo.name == 'Cadastre transparent' ) {
            cadastresep_transp.setOpacity(0),
            ign_ortho.setOpacity(1);
            ign_scan.setOpacity(1);
            osm.setOpacity(1);
            Topo.setOpacity(1);
          }
        })
        
        map.on('overlayadd', function(eo)
        {
          if( eo.name == 'GeoFoncier' ) {
            geofoncier_limites.setOpacity(1),
            ign_ortho.setOpacity(0.5);
            ign_scan.setOpacity(0.7);
            osm.setOpacity(0.7);
            Topo.setOpacity(0.7);
          }
          else {
            geofoncier_limites.setOpacity(0);
          }
        })
        map.on('overlayremove', function(eo)
        {
          if( eo.name == 'GeoFoncier' ) {
            geofoncier_limites.setOpacity(0),
            ign_ortho.setOpacity(1);
            ign_scan.setOpacity(1);
            osm.setOpacity(1);
            Topo.setOpacity(1);
          }
        })
        
        
        
        
        L.control.scale({imperial: false}).addTo(map);
	      L.control.layers(baseMaps,overlays).addTo(map);
        new L.Control.GeoSearch({
          provider: new L.GeoSearch.Provider.OpenStreetMap(),
            position: 'topleft',
            showMarker: true,
            retainZoomLevel: false,
            }).addTo(map);
	      L.control.locate({drawCircle: true,
      		position: 'topleft',
		enableHighAccuracy: true,
      		strings: {
        		title: "Se localiser"
        		}
    	     }).addTo(map);
    </script>
</body>
</html>
